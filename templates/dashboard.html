{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UGC Staff | Departmental Dashboard</title>
    <link rel="stylesheet" href="{% static 'loader.css' %}">
    <link rel="icon" type="image/png" href="{% static 'images/ugc.png' %}">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0a0a0a;
            --card: #141414;
            --gold: #c5a059;
            --gold-glow: rgba(197, 160, 89, 0.3);
            --border: #222;
            --text-muted: #888;
            --error: #ff4d4d;
            --success: #4caf50;
            --footer-bg: #050505;
            --font-main: 'Montserrat', sans-serif;
            --info: #17a2b8;
        }

        /* --- UPDATED NOTIFICATION TOAST --- */
        .toast-notification {
            position: fixed;
            top: 30px;
            right: 30px;
            background: var(--card);
            border: 1px solid var(--gold);
            padding: 18px 25px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 10000;
            transform: translateX(150%);
            transition: transform 0.6s cubic-bezier(0.23, 1, 0.32, 1);
            box-shadow: 0 15px 40px rgba(0,0,0,0.8), 0 0 20px var(--gold-glow);
            min-width: 320px;
        }

        .toast-notification.show { transform: translateX(0); }

        .toast-icon {
            width: 32px;
            height: 32px;
            background: var(--gold);
            color: #000;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: 900;
            font-size: 18px;
            flex-shrink: 0;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        .toast-delete {
            border-color: var(--error);
            box-shadow: 0 15px 40px rgba(0,0,0,0.8), 0 0 20px rgba(255, 77, 77, 0.2);
        }
        .toast-delete .toast-icon {
            background: var(--error);
            color: #fff;
        }

        /* --- CUSTOM DELETE MODAL STYLES --- */
        .delete-icon-circle {
            width: 80px;
            height: 80px;
            border: 3px solid var(--error);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0 auto 20px;
            color: var(--error);
            font-size: 40px;
            font-weight: 300;
        }

        .delete-modal-title {
            font-size: 1.5rem;
            font-weight: 800;
            color: #fff;
            margin-bottom: 10px;
        }

        .delete-modal-text {
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-bottom: 25px;
            line-height: 1.5;
        }

        .btn-confirm-delete {
            background: #6c5ce7; 
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            transition: 0.3s;
        }

        .btn-confirm-delete:hover { opacity: 0.9; transform: translateY(-2px); }

        /* Existing Dashboard Styles... */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { background: var(--bg); color: #fff; font-family: var(--font-main); display: flex; flex-direction: column; min-height: 100vh; overflow-x: hidden; }
        .dashboard-container { max-width: 1300px; margin: 40px auto; padding: 0 20px; width: 100%; flex: 1; }
        .dash-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; border-bottom: 1px solid var(--border); padding-bottom: 20px; }
        .header-right { display: flex; align-items: center; gap: 15px; }
        .role-badge { background: var(--gold); color: #000; padding: 5px 15px; border-radius: 20px; font-size: 0.75rem; font-weight: 800; text-transform: uppercase; }
        .btn-logout { background: transparent; color: var(--error); border: 1px solid var(--error); padding: 6px 15px; border-radius: 6px; font-size: 0.75rem; font-weight: 700; cursor: pointer; transition: 0.3s; text-transform: uppercase; font-family: 'Montserrat'; }
        .btn-logout:hover { background: var(--error); color: #fff; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 40px; }
        .stat-card { background: var(--card); border: 1px solid var(--border); padding: 20px; border-radius: 12px; text-align: center; }
        .stat-card h3 { font-size: 2rem; color: var(--gold); margin: 10px 0; }
        .stat-card p { font-size: 0.8rem; color: var(--text-muted); text-transform: uppercase; font-weight: 700; }
        
        /* UPDATED SEARCH CONTAINER FOR FILTERS */
        .search-container { margin-bottom: 20px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
        .search-input { flex: 2; min-width: 250px; background: var(--card); border: 1px solid var(--border); padding: 12px 20px; border-radius: 8px; color: #fff; font-family: inherit; outline: none; transition: 0.3s; }
        .filter-select { flex: 1; min-width: 140px; background: var(--card); border: 1px solid var(--border); padding: 12px; border-radius: 8px; color: #fff; font-family: inherit; outline: none; cursor: pointer; }
        .search-input:focus, .filter-select:focus { border-color: var(--gold); box-shadow: 0 0 10px rgba(197, 160, 89, 0.1); }
        
        .btn-export { background: #1e1e1e; color: var(--gold); border: 1px solid var(--gold); padding: 12px 20px; border-radius: 8px; font-weight: 700; font-size: 0.75rem; cursor: pointer; text-transform: uppercase; transition: 0.3s; }
        .btn-export:hover { background: var(--gold); color: #000; }
        .btn-bulk-delete { background: var(--error); color: #fff; border: none; padding: 12px 20px; border-radius: 8px; font-weight: 700; font-size: 0.75rem; cursor: pointer; text-transform: uppercase; display: none; transition: 0.3s; }
        .ticket-table-container { background: var(--card); border: 1px solid var(--border); border-radius: 15px; overflow-x: auto; margin-bottom: 80px; }
        table { width: 100%; border-collapse: collapse; text-align: left; min-width: 800px; }
        th { background: #1a1a1a; padding: 15px 20px; font-size: 0.75rem; text-transform: uppercase; color: var(--gold); letter-spacing: 1px; }
        td { padding: 15px 20px; border-bottom: 1px solid var(--border); font-size: 0.85rem; }
        .check-col { width: 40px; text-align: center; }
        .ticket-checkbox { cursor: pointer; transform: scale(1.2); accent-color: var(--gold); }
        .dept-tag { font-size: 10px; font-weight: 800; background: #222; color: var(--gold); padding: 2px 8px; border-radius: 4px; border: 1px solid #333; text-transform: uppercase; }
        .status-pill { padding: 4px 10px; border-radius: 4px; font-size: 0.7rem; font-weight: 700; white-space: nowrap; }
        .status-open { background: rgba(255, 255, 255, 0.1); color: #fff; }
        .status-progress { background: rgba(197, 160, 89, 0.2); color: var(--gold); }
        .status-resolved { background: rgba(76, 175, 80, 0.2); color: #4caf50; }
        .action-cell { display: flex; gap: 8px; align-items: center; }
        .action-cell select { background: #000; color: #fff; border: 1px solid var(--border); padding: 5px; border-radius: 4px; cursor: pointer; font-family: inherit; font-size: 0.8rem; }
        .btn-respond { background: var(--gold); color: #000; border: none; padding: 6px 12px; border-radius: 4px; font-weight: 700; font-size: 0.7rem; cursor: pointer; text-transform: uppercase; }
        .btn-delete { background: transparent; color: var(--error); border: 1px solid var(--error); padding: 5px 10px; border-radius: 4px; font-weight: 700; font-size: 0.7rem; cursor: pointer; text-transform: uppercase; transition: 0.3s; }
        .btn-delete:hover { background: var(--error); color: #fff; }
        
        .badge-new { background: var(--error); color: white; font-size: 9px; padding: 2px 6px; border-radius: 4px; margin-left: 5px; vertical-align: middle; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: var(--card); border: 1px solid var(--gold); padding: 30px; border-radius: 15px; width: 90%; max-width: 600px; position: relative; }
        .modal-content h2 { color: var(--gold); margin-bottom: 15px; font-size: 1.2rem; }

        /* --- NEW MODAL CLOSE BUTTON --- */
        .modal-close-x {
            position: absolute;
            top: 15px;
            right: 20px;
            color: var(--text-muted);
            font-size: 24px;
            cursor: pointer;
            transition: 0.3s;
        }
        .modal-close-x:hover { color: var(--error); transform: scale(1.1); }
        
        /* --- UPDATED THREAD BOX STYLES --- */
        .original-msg-box { background: #000; border: 1px solid #222; padding: 15px; border-radius: 8px; margin-bottom: 15px; font-size: 0.85rem; max-height: 250px; overflow-y: auto; }
        .thread-entry { border-bottom: 1px solid #111; padding: 10px 0; margin-bottom: 5px; position: relative; }
        .thread-entry:last-child { border-bottom: none; }
        .thread-meta { display: flex; justify-content: space-between; font-size: 10px; color: var(--text-muted); margin-bottom: 5px; }
        .thread-sender { font-weight: 700; color: var(--gold); }
        .thread-msg { line-height: 1.4; color: #eee; white-space: pre-wrap; }
        
        .staff-reply-context { font-size: 10px; border-left: 2px solid var(--gold); padding-left: 8px; margin: 5px 0; color: var(--text-muted); font-style: italic; background: rgba(255,255,255,0.03); padding: 4px; }

        .btn-inline-reply { font-size: 9px; background: #222; color: #888; border: 1px solid #333; padding: 2px 6px; border-radius: 3px; cursor: pointer; transition: 0.3s; }
        .btn-inline-reply:hover { border-color: var(--gold); color: var(--gold); }
        
        .quote-preview { background: #1a1a1a; border-left: 3px solid var(--gold); padding: 8px 12px; margin-bottom: 10px; border-radius: 4px; display: none; position: relative; }
        .quote-preview .close-quote { position: absolute; top: 5px; right: 10px; color: var(--error); cursor: pointer; font-size: 14px; }

        .modal-content textarea { width: 100%; height: 100px; background: #000; border: 1px solid var(--border); color: #fff; padding: 15px; border-radius: 8px; margin-bottom: 15px; font-family: inherit; resize: none; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; }
        .btn-cancel { background: transparent; color: #fff; border: 1px solid var(--border); padding: 10px 20px; border-radius: 6px; cursor: pointer; }
        .btn-send { background: var(--gold); color: #000; border: none; padding: 10px 20px; border-radius: 6px; font-weight: 700; cursor: pointer; }

        footer { background: var(--footer-bg); padding: 60px 0 20px; border-top: 1px solid var(--border); width: 100%; }
        footer .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        .footer-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 40px; }
        .footer-logo { display: block; margin-bottom: 20px; }
        .footer-col h4 { color: #fff; text-transform: uppercase; font-size: 0.85rem; letter-spacing: 1px; margin-bottom: 20px; }
        .footer-col p { color: var(--text-muted); font-size: 0.9rem; line-height: 1.6; }
        .footer-col ul { list-style: none; padding: 0; }
        .footer-col ul li { margin-bottom: 10px; }
        .footer-col ul li a { color: var(--text-muted); text-decoration: none; font-size: 0.9rem; transition: 0.3s; }
        .footer-col ul li a:hover { color: var(--gold); }
        .copyright { text-align: center; margin-top: 50px; padding-top: 20px; border-top: 1px solid var(--border); color: #444; font-size: 0.75rem; letter-spacing: 1px; font-weight: 600; }

        @media (max-width: 768px) { .footer-grid { grid-template-columns: 1fr; text-align: center; } .footer-logo img { margin: 0 auto; } .search-container { flex-direction: column; align-items: stretch; } }
    </style>
</head>
<body>

<div id="global-loader">
    <div class="loader-ring"></div>
    <div class="loader-text">Loading UGC</div>
</div>

<div id="replyToast" class="toast-notification">
    <div class="toast-icon" id="toastIcon">✓</div>
    <div>
        <div id="toastTitle" style="font-weight: 800; color: var(--gold); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px;">System Update</div>
        <div id="toastMessage" style="font-size: 0.85rem; color: #fff; line-height: 1.4; margin-top: 2px;"></div>
    </div>
</div>

<div class="modal-overlay" id="deleteConfirmModal">
    <div class="modal-content" style="text-align: center; border-color: var(--error); max-width: 400px;">
        <div class="delete-icon-circle">✕</div>
        <h2 class="delete-modal-title">Critical Action</h2>
        <p class="delete-modal-text">Permanently remove this record from the database? This action cannot be undone.</p>
        <div class="modal-actions" style="justify-content: center; gap: 15px;">
            <button class="btn-cancel" onclick="closeDeleteModal()">Cancel</button>
            <button id="confirmDeleteBtn" class="btn-confirm-delete">OK</button>
        </div>
    </div>
</div>

<div class="dashboard-container">
    <div class="dash-header">
        <div>
            <h1 id="deptTitle">{{ department }} Dashboard</h1>
            <p id="staffGreeting" style="color: var(--text-muted);">Welcome back, {{ user.username }}</p>
        </div>
        <div class="header-right">
            <span class="role-badge" id="roleLabel">Role: {{ role }}</span>
            <button class="btn-logout" onclick="document.getElementById('logoutModal').style.display='flex'">Logout</button>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <p>Total Tickets</p>
            <h3 id="countPending">{{ tickets.count }}</h3>
        </div>
        <div class="stat-card">
            <p>Status</p>
            <h3 id="countResolved">ONLINE</h3>
        </div>
        <div class="stat-card">
            <p>System Health</p>
            <h3 style="color: #4caf50;">ACTIVE</h3>
        </div>
    </div>

    <div class="search-container">
        <input type="text" id="ticketSearch" class="search-input" placeholder="Search by ID, Name, Subject..." onkeyup="filterTable()">
        
        <select id="statusFilter" class="filter-select" onchange="filterTable()">
            <option value="">All Statuses</option>
            <option value="Open">Open</option>
            <option value="In-Progress">In-Progress</option>
            <option value="Resolved">Resolved</option>
        </select>

        {% if department == 'University-Wide (Super Command)' %}
        <select id="deptFilter" class="filter-select" onchange="filterTable()">
            <option value="">All Departments</option>
            <option value="ADMISSION">Admission</option>
            <option value="FINANACE">Finance</option>
            <option value="STUDENT SUPPORT SERVICE">Student Support Service</option>
            <option value="H.R.">H.R.</option>
            <option value="I.T.">I.T.</option>
        </select>
        {% endif %}

        {% if is_super_command %}
        <button id="bulkDeleteBtn" class="btn-bulk-delete" onclick="handleBulkDelete()">Delete Selected (0)</button>
        {% endif %}
        <button class="btn-export" onclick="exportToExcel()">Export to Excel</button>
    </div>

    <div class="ticket-table-container">
        <table id="mainTicketTable">
            <thead>
                <tr>
                    {% if is_super_command %}<th class="check-col"><input type="checkbox" id="selectAll" onclick="toggleSelectAll()"></th>{% endif %}
                    <th>Ref ID</th>
                    <th>Subject & Latest Reply</th>
                    {% if department == 'University-Wide (Super Command)' %}<th>Origin Dept</th>{% endif %}
                    <th>Sender Identity</th>
                    <th>Status</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="ticketList">
                {% for ticket in tickets %}
                <tr class="ticket-row" id="row-{{ ticket.id }}">
                    {% if is_super_command %}
                    <td class="check-col"><input type="checkbox" class="ticket-checkbox" value="{{ ticket.id }}" onclick="updateBulkBtn()"></td>
                    {% endif %}
                    <td style="font-weight: 700; color: var(--gold);" class="col-id">
                        {{ ticket.formatted_id }}
                        {% if ticket.last_reply_by == 'USER' %}
                            <span class="badge-new">NEW</span>
                        {% endif %}
                    </td>
                    <td class="col-subject">
                        <div style="max-width: 300px;">
                            <strong style="display: block; font-size: 0.9rem; margin-bottom: 4px;">{{ ticket.subject }}</strong>
                            <small style="color: var(--text-muted); display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; border-left: 2px solid {% if ticket.last_reply_by == 'USER' %}var(--error){% else %}var(--gold){% endif %}; padding-left: 8px;">
                                {% if ticket.reply_message %}
                                    <span style="color: {% if ticket.last_reply_by == 'USER' %}var(--error){% else %}var(--gold){% endif %};">
                                        {% if ticket.last_reply_by == 'USER' %}User Response:{% else %}Latest Staff: ({{ ticket.last_staff_name|default:"Officer" }}){% endif %}
                                    </span> {{ ticket.reply_message }}
                                {% else %}
                                    {{ ticket.message }}
                                {% endif %}
                            </small>
                            <span style="font-size: 10px; color: #444;">Updated: {{ ticket.updated_at|date:"M d, H:i" }}</span>
                        </div>
                    </td>
                    {% if department == 'University-Wide (Super Command)' %}
                    <td class="col-dept"><span class="dept-tag">{{ ticket.department }}</span></td>
                    {% endif %}
                    <td class="col-sender">
                        <div style="line-height: 1.3;">
                            <strong style="color: #fff;">{{ ticket.name }}</strong><br>
                            <span class="dept-tag" style="background: {% if ticket.user_type == 'STUDENT' %}#2a5298{% elif ticket.user_type == 'STAFF' %}#c5a059{% else %}#333{% endif %}; color: {% if ticket.user_type == 'STAFF' %}#000{% else %}#fff{% endif %};">
                                {{ ticket.user_type }} {% if ticket.student_id %}({{ ticket.student_id }}){% elif ticket.staff_id %}({{ ticket.staff_id }}){% endif %}
                            </span>
                        </div>
                    </td>
                    <td class="col-status">
                        <span class="status-pill {% if ticket.status == 'Open' %}status-open{% elif ticket.status == 'In-Progress' %}status-progress{% else %}status-resolved{% endif %}">
                            {{ ticket.status }}
                        </span>
                    </td>
                    <td class="action-cell">
                        <button class="btn-respond" onclick="openModal('{{ ticket.id }}', '{{ ticket.message|escapejs }}', '{{ ticket.formatted_id }}', '{{ ticket.email|escapejs }}', '{{ ticket.name|escapejs }}')">Reply</button>
                        <select onchange="updateStatus('{{ ticket.id }}', this.value)">
                            <option value="Open" {% if ticket.status == 'Open' %}selected{% endif %}>Open</option>
                            <option value="In-Progress" {% if ticket.status == 'In-Progress' %}selected{% endif %}>In-Progress</option>
                            <option value="Resolved" {% if ticket.status == 'Resolved' %}selected{% endif %}>Resolved</option>
                        </select>
                        {% if is_super_command %}
                        <button class="btn-delete" onclick="confirmDelete('{{ ticket.id }}')">Delete</button>
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr><td colspan="8" style="text-align:center; padding: 40px; color: #444;">No records found.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="modal-overlay" id="replyModal">
    <div class="modal-content">
        <span class="modal-close-x" onclick="closeModal()">✕</span>
        
        <form id="replyForm" onsubmit="event.preventDefault(); submitStaffReply();">
            {% csrf_token %}
            <h2>Send Response</h2>
            <p id="replyEmail" style="font-size: 0.75rem; color: #888;"></p>
            <p id="replyTo" style="font-size: 0.8rem; color: var(--gold); margin-bottom: 10px;"></p>
            
            <div class="original-msg-box" id="messageThreadContainer"></div>

            <div class="quote-preview" id="quotePreview">
                <span class="close-quote" onclick="clearQuote()">✕</span>
                <small style="color: var(--gold); font-size: 9px; text-transform: uppercase;">Replying to:</small>
                <div id="quoteText" style="font-size: 0.8rem; color: #ccc; font-style: italic;"></div>
            </div>

            <textarea id="replyText" required placeholder="Provide the solution or update..."></textarea>
            
            <div class="modal-actions">
                <button type="button" class="btn-cancel" onclick="closeModal()">Cancel</button>
                <button type="submit" class="btn-send">Send Reply</button>
            </div>
        </form>
    </div>
</div>

<div class="modal-overlay" id="logoutModal">
    <div class="modal-content" style="text-align: center;">
        <h2>Confirm Logout</h2>
        <p style="color: var(--error); margin-bottom: 20px;">Are you sure you want to end your session?</p>
        <div class="modal-actions" style="justify-content: center;">
            <button class="btn-cancel" onclick="document.getElementById('logoutModal').style.display='none'">Stay</button>
            <button class="btn-send" style="background: var(--error); color: #fff;" onclick="window.location.href='/logout/'">Logout</button>
        </div>
    </div>
</div>

<footer>
    <div class="container">
        <div class="footer-grid">
            <div class="footer-col">
                <a href="/" class="footer-logo">
                    <img src="{% static 'images/ugc.png' %}" alt="UGC Logo" style="width: 180px; height: auto;">
                </a>
                <p>UGC understands Ghana's workforce dynamics, offering flexible education for corporate executives and entrepreneurs through its specialized Graduate Schools.</p>
            </div>
            <div class="footer-col">
                <h4>Academic Portals</h4>
                <ul>
                    <li><a href="#">Postgraduate Admissions</a></li>
                    <li><a href="#">Graduation Portal</a></li>
                </ul>
            </div>
            <div class="footer-col">
                <h4>Quick Links</h4>
                <ul>
                    <li><a href="/">Support Desk</a></li>
                    <li><a href="/#/">Staff Email</a></li>
                </ul>
            </div>
            <div class="footer-col">
                <h4>Campus Location</h4>
                <p>Christ Square, Spintex Road<br>Accra, Ghana</p>
                <p style="margin-top: 10px; color: var(--gold);">Email: info@ugc.edu.gh</p>
            </div>
        </div>
        <div class="copyright">
            &copy; 2026 UNIVERSITY OF GOLD COAST (UGC). ALL RIGHTS RESERVED.
        </div>
    </div>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="{% static 'loader.js' %}"></script>

<script>
    let activeTicketData = {};
    let deleteTargetId = null;
    let selectedParentMessageId = null; 
    let messagesMap = {}; 

    function showToast(message, title = "System Update", type = "success") {
        const toast = document.getElementById('replyToast');
        const icon = document.getElementById('toastIcon');
        const titleEl = document.getElementById('toastTitle');
        const messageEl = document.getElementById('toastMessage');
        
        toast.classList.remove('toast-delete', 'show');
        void toast.offsetWidth; 
        
        if (type === "delete" || type === "deleted" || type === "error") {
            toast.classList.add('toast-delete');
            icon.innerText = "✕"; 
            titleEl.style.color = "var(--error)";
        } else {
            icon.innerText = "✓";
            titleEl.style.color = "var(--gold)";
        }
        
        titleEl.innerText = title;
        messageEl.innerHTML = message;

        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 4500);
    }

    function confirmDelete(id) {
        deleteTargetId = id;
        document.querySelector('#deleteConfirmModal .delete-modal-text').innerText = "CRITICAL ACTION: Permanently remove this record from the database?";
        document.getElementById('confirmDeleteBtn').onclick = executeDelete;
        document.getElementById('deleteConfirmModal').style.display = 'flex';
    }

    function closeDeleteModal() {
        document.getElementById('deleteConfirmModal').style.display = 'none';
        deleteTargetId = null;
    }

    async function executeDelete() {
        const id = deleteTargetId;
        closeDeleteModal();
        try {
            const response = await fetch(window.location.origin + `/delete-ticket/${id}/`, {
                headers: { 
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                }
            });
            
            if (!response.ok) {
                showToast(`Server Error: ${response.status}`, "Request Failed", "error");
                return;
            }

            const data = await response.json();
            
            if (data.status === 'deleted') {
                const row = document.getElementById(`row-${id}`);
                if (row) {
                    row.style.background = "rgba(255, 77, 77, 0.15)";
                    row.style.opacity = '0.3';
                    row.style.pointerEvents = 'none';
                    row.style.transition = "0.5s ease";
                    setTimeout(() => row.remove(), 1000);
                }
                showToast(data.message || "Record successfully purged.", "Ticket Deleted", "delete");
                const countEl = document.getElementById('countPending');
                if (countEl) countEl.innerText = Math.max(0, parseInt(countEl.innerText) - 1);
            } else { 
                showToast(data.message || "Action Denied.", "System Error", "error");
            }
        } catch (err) { 
            showToast(`Debug: ${err.message}`, "Connection Error", "error");
        }
    }

    async function handleBulkDelete() {
        const selectedIds = Array.from(document.querySelectorAll('.ticket-checkbox:checked')).map(cb => cb.value);
        if (selectedIds.length === 0) return;
        
        document.querySelector('#deleteConfirmModal .delete-modal-text').innerText = `PURGE ${selectedIds.length} RECORDS? This action cannot be undone.`;
        document.getElementById('confirmDeleteBtn').onclick = async () => {
            closeDeleteModal();
            try {
                const response = await fetch(window.location.origin + `/bulk-delete-tickets/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ ticket_ids: selectedIds })
                });

                if (!response.ok) {
                    showToast(`Server Error: ${response.status}`, "Bulk Failed", "error");
                    return;
                }

                const data = await response.json();
                if (data.status === 'deleted') {
                    showToast(`${selectedIds.length} records wiped.`, "Bulk Purge Complete", "delete");
                    setTimeout(() => location.reload(), 1500);
                } else { 
                    showToast("Bulk operation denied.", "System Error", "error"); 
                }
            } catch (err) { 
                showToast(`Debug: ${err.message}`, "Network Error", "error"); 
            }
        };
        document.getElementById('deleteConfirmModal').style.display = 'flex';
    }

    async function openModal(id, msg, formattedId, email, name) {
        activeTicketData = { id, formattedId, email, name };
        document.getElementById('replyEmail').innerText = `To: ${email}`;
        document.getElementById('replyTo').innerText = `Ref: ${formattedId}`;
        const container = document.getElementById('messageThreadContainer');
        container.innerHTML = "<p style='color:var(--gold); font-size:10px;'>Fetching conversation history...</p>";
        
        clearQuote();
        document.getElementById('replyModal').style.display = 'flex';

        try {
            const res = await fetch(`/get-messages/${id}/`);
            const data = await res.json();
            
            messagesMap = {}; 
            if(data.messages && data.messages.length > 0) {
                container.innerHTML = "";
                data.messages.forEach(m => {
                    messagesMap[m.id] = m.message; 
                    
                    let contextHtml = "";
                    if(m.parent_id && messagesMap[m.parent_id]) {
                        contextHtml = `<div class="staff-reply-context">Replying to: "${messagesMap[m.parent_id].substring(0, 40)}..."</div>`;
                    }

                    const entry = document.createElement('div');
                    entry.className = "thread-entry";
                    entry.innerHTML = `
                        <div class="thread-meta">
                            <span class="thread-sender">${m.sender_name} ${m.is_staff ? '(Staff)' : ''}</span>
                            <span>${m.created_at}</span>
                        </div>
                        ${contextHtml}
                        <div class="thread-msg">${m.message}</div>
                        <div style="text-align:right; margin-top:5px;">
                            <button type="button" class="btn-inline-reply" onclick="setReplyParent('${m.id}', '${m.message.replace(/'/g, "\\'").substring(0,60)}...')">Reply to this</button>
                        </div>
                    `;
                    container.appendChild(entry);
                });
                container.scrollTop = container.scrollHeight;
            } else {
                container.innerHTML = `<div class="thread-entry"><div class="thread-msg">${msg}</div></div>`;
            }
        } catch(e) { 
            container.innerHTML = `<div class="thread-entry"><div class="thread-msg">${msg}</div></div>`;
        }
    }

    function setReplyParent(id, text) {
        selectedParentMessageId = id;
        document.getElementById('quoteText').innerText = text;
        document.getElementById('quotePreview').style.display = 'block';
        document.getElementById('replyText').focus();
    }

    function clearQuote() {
        selectedParentMessageId = null;
        document.getElementById('quotePreview').style.display = 'none';
    }

    function closeModal() {
        document.getElementById('replyModal').style.display = 'none';
        document.getElementById('replyText').value = '';
        clearQuote();
    }

    async function submitStaffReply() {
        const replyText = document.getElementById('replyText').value.trim();
        if (!replyText || !activeTicketData.id) return;
        
        try {
            const response = await fetch(`/submit-reply/${activeTicketData.id}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 
                    'message': replyText,
                    'parent_id': selectedParentMessageId 
                })
            });
            if (response.ok) {
                closeModal();
                showToast(`Response dispatched to <b>${activeTicketData.name}</b>`, "Reply Sent", "success");
                setTimeout(() => location.reload(), 1500);
            } else {
                showToast(`Reply failed: ${response.status}`, "Server Error", "error");
            }
        } catch (err) { showToast(`Debug: ${err.message}`, "Connection Error", "error"); }
    }

    function toggleSelectAll() {
        const master = document.getElementById('selectAll');
        const boxes = document.querySelectorAll('.ticket-checkbox');
        boxes.forEach(box => box.checked = master.checked);
        updateBulkBtn();
    }

    function updateBulkBtn() {
        const selected = document.querySelectorAll('.ticket-checkbox:checked').length;
        const btn = document.getElementById('bulkDeleteBtn');
        if(btn) {
            btn.style.display = selected > 0 ? 'block' : 'none';
            btn.innerText = `Delete Selected (${selected})`;
        }
    }

    /* --- UPDATED ADVANCED FILTERING LOGIC --- */
    function filterTable() {
        // 1. Get current filter values
        const searchText = document.getElementById("ticketSearch").value.toLowerCase();
        const statusFilter = document.getElementById("statusFilter").value.toLowerCase();
        const deptFilterEl = document.getElementById("deptFilter");
        const deptFilter = deptFilterEl ? deptFilterEl.value.toLowerCase() : "";

        const rows = document.querySelectorAll("#ticketList tr.ticket-row");

        rows.forEach(row => {
            // 2. Extract values from specific table cells
            const fullRowText = row.innerText.toLowerCase(); 
            const statusCellText = row.querySelector(".status-pill").innerText.toLowerCase().trim();
            
            // Safe selection for department tag column
            const deptTagCol = row.querySelector(".col-dept .dept-tag");
            const deptCellText = deptTagCol ? deptTagCol.innerText.toLowerCase().trim() : "";

            // 3. Multi-Criteria Matching Logic
            const matchesSearch = fullRowText.includes(searchText);
            const matchesStatus = statusFilter === "" || statusCellText === statusFilter;
            const matchesDept = deptFilter === "" || deptCellText === deptFilter;

            // 4. Update row visibility
            if (matchesSearch && matchesStatus && matchesDept) {
                row.style.display = "";
            } else {
                row.style.display = "none";
            }
        });
    }

    async function updateStatus(id, newStatus) {
        try {
            const response = await fetch(`/update-status/${id}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 'status': newStatus })
            });
            if (response.ok) {
                showToast(`Ticket status transitioned to ${newStatus}`, "Status Updated", "success");
                setTimeout(() => location.reload(), 800);
            } else {
                showToast(`Update failed: ${response.status}`, "Server Error", "error");
            }
        } catch (err) { showToast(`Debug: ${err.message}`, "Error", "error"); }
    }

    function exportToExcel() {
        const table = document.getElementById("mainTicketTable");
        const wb = XLSX.utils.table_to_book(table, {sheet: "Tickets"});
        XLSX.writeFile(wb, "UGC_Tickets_Export.xlsx");
    }
</script>
</body>
</html>